<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmreDetails | Admin</title>
    
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE DESIGN --- */
        body { overflow: hidden; display: flex; height: 100vh; background: #050505; color: #ddd; font-family: 'Inter', sans-serif; }
        
        aside {
            width: 280px; background: #0f0f0f; border-right: 1px solid #222;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; transition: transform 0.3s ease;
        }
        main {
            flex: 1; display: flex; flex-direction: column; position: relative;
            background: #141414; 
        }
        header {
            height: 70px; border-bottom: 1px solid #222; display: flex; 
            align-items: center; justify-content: space-between; padding: 0 30px;
            background: #0f0f0f;
        }

        /* Sidebar Elements */
        .sidebar-header { height: 70px; display: flex; align-items: center; padding: 0 24px; border-bottom: 1px solid #222; }
        .nav-category { font-size: 11px; text-transform: uppercase; color: #555; padding: 24px 24px 10px; font-weight: 700; letter-spacing: 1px; }
        .nav-item {
            padding: 12px 24px; margin: 2px 0;
            color: #888; font-size: 14px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { background: #1a1a1a; color: #fff; }
        .nav-item.active { background: #1a1a1a; color: #fff; font-weight: 500; border-left-color: #fff; }
        .badge-count { background: #000; padding: 2px 8px; border-radius: 6px; font-size: 11px; color: #555; }

        /* Mobile specific elements */
        .burger-btn { display: none; background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; margin-right: 15px; }
        .mobile-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 40; display: none; backdrop-filter: blur(2px); }
        .mobile-overlay.active { display: block; }

        @media (max-width: 768px) {
            aside { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); width: 85%; max-width: 300px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            aside.open { transform: translateX(0); }
            .burger-btn { display: block; }
            header { padding: 0 15px; }
            
            /* MOBILE FLOATING HISTORY BUTTONS */
            .history-group {
                position: fixed;
                top: 85px; /* Abstand von oben (unter Header) */
                right: 20px; /* Abstand von rechts */
                background: rgba(20, 20, 20, 0.95);
                backdrop-filter: blur(10px);
                padding: 8px 12px;
                border-radius: 30px;
                border: 1px solid #333;
                box-shadow: 0 4px 15px rgba(0,0,0,0.5);
                z-index: 900;
                display: flex !important;
                gap: 12px;
            }
            /* Verstecke den Border rechts im Header, da Buttons jetzt floating sind */
            .history-group { border-right: none !important; margin-right: 0 !important; padding-right: 0 !important; }
        }

        /* Editor Area */
        .editor-scroll { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        .editor-container { max-width: 800px; margin: 0 auto; padding-bottom: 100px; }
        @media (max-width: 768px) { .editor-scroll { padding: 20px; } }

        .cms-card {
            background: #1a1a1a; border: 1px solid #2a2a2a;
            border-radius: 12px; margin-bottom: 40px; 
            overflow: visible; 
            transition: border-color 0.2s;
        }
        .cms-card:hover { border-color: #333; }
        .cms-card-header {
            background: #222; padding: 16px 24px; border-bottom: 1px solid #2a2a2a;
            font-size: 13px; font-weight: 700; color: #bbb; text-transform: uppercase; letter-spacing: 1px;
            border-radius: 12px 12px 0 0;
        }
        .cms-card-body { padding: 24px; display: grid; gap: 24px; }

        /* Sub-Headlines */
        .cms-separator { 
            grid-column: 1 / -1; margin-top: 15px; margin-bottom: 5px; padding-bottom: 10px; 
            border-bottom: 1px solid #333; color: #666; font-size: 11px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; 
        }

        /* Inputs */
        .cms-field-wrap { position: relative; }
        .cms-label-small { display: block; font-size: 11px; color: #666; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        
        .cms-input {
            width: 100%; background: #0a0a0a; border: 1px solid #333;
            color: #ddd; padding: 12px 14px; border-radius: 8px;
            font-family: inherit; font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .cms-input:focus { border-color: #555; background: #000; }

        /* --- VISUAL EDITOR (WYSIWYG) --- */
        .cms-editor {
            width: 100%; min-height: 46px; 
            background: #0a0a0a; border: 1px solid #333;
            color: #ddd; padding: 12px 14px; border-radius: 8px;
            font-family: inherit; font-size: 14px; line-height: 1.5;
            outline: none; overflow-y: auto; white-space: pre-wrap;
            transition: all 0.2s;
        }
        .cms-editor:focus { border-color: #555; background: #000; min-height: 80px; }
        
        .cms-editor b, .cms-editor strong { color: #fff; font-weight: 700; }
        .cms-editor i, .cms-editor em { font-style: italic; color: #bbb; }
        .cms-editor u { text-decoration: underline; text-decoration-color: #555; }

        /* Toolbar */
        .format-toolbar {
            display: flex; gap: 4px; position: absolute; top: -38px; right: 0;
            background: #222; padding: 4px; border-radius: 6px; border: 1px solid #333;
            opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s;
            transform: translateY(5px); z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .cms-field-wrap:focus-within .format-toolbar { opacity: 1; pointer-events: all; transform: translateY(0); }
        
        .format-btn {
            background: transparent; border: none; color: #aaa;
            width: 28px; height: 28px; border-radius: 4px; cursor: pointer;
            font-family: serif; font-size: 15px; display: grid; place-items: center;
        }
        .format-btn:hover { background: #333; color: #fff; }

        /* Social Icons Input */
        .social-input-wrap { display: flex; align-items: center; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .social-icon-box { width: 44px; height: 44px; display: grid; place-items: center; background: #151515; border-right: 1px solid #333; }
        .social-icon-box img { width: 22px; height: 22px; object-fit: contain; }
        .social-input-wrap input { border: none; background: transparent; flex: 1; height: 44px; padding: 0 14px; color: #ddd; outline: none; }
        .social-input-wrap:focus-within { border-color: #555; }

        /* Welcome Toast */
        #welcome-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #222; border: 1px solid #333; color: #fff;
            padding: 12px 24px; border-radius: 50px; z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 10px; width: max-content; max-width: 90%;
        }
        #welcome-toast.show { transform: translateX(-50%) translateY(0); }

        /* Modals & Utils */
        #login-overlay, #media-modal { background: rgba(0,0,0,0.95); }
        .hidden { display: none !important; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        
        /* Undo/Redo Buttons */
        .history-btn {
            background: #222; border: 1px solid #333; color: #888;
            width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
            display: grid; place-items: center; transition: all 0.2s;
        }
        .history-btn:hover:not(:disabled) { background: #333; color: #fff; }
        .history-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="welcome-toast">
        <i class="fa-solid fa-hand-sparkles" style="color: #648cff;"></i>
        Willkommen! Was ändern wir heute?
    </div>

    <div id="login-overlay" style="position:fixed; inset:0; z-index:9999; display:grid; place-items:center;">
        <div style="background:#111; padding:40px; border-radius:12px; border:1px solid #333; text-align:center; width:350px;">
            <h2 style="color:#fff; margin-bottom:20px;">Admin Login</h2>
            <form onsubmit="event.preventDefault(); doLogin();">
                <input type="password" id="password-input" placeholder="Passwort" class="cms-input" style="text-align:center; margin-bottom:15px; font-size:16px;">
                <button type="submit" id="login-btn" class="pill pill--primary pill--full">Einloggen</button>
            </form>
            <p id="login-error" style="color:#ff5555; margin-top:15px; font-size:13px;"></p>
        </div>
    </div>

    <div id="media-modal" style="position:fixed; inset:0; z-index:9000; display:none; flex-direction:column; padding:40px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="color:#fff;">Bild auswählen</h2>
            <button onclick="closeLibrary()" style="background:none; border:none; color:#aaa; cursor:pointer;">Schließen (ESC)</button>
        </div>
        <div id="media-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:15px; overflow:auto;"></div>
    </div>

    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleSidebar()"></div>

    <div id="app" class="hidden" style="width:100%;">
        
        <aside id="sidebar">
            <div class="sidebar-header">
                <img src="/logo.png" 
                     style="max-height:40px; width:auto; margin-right:15px;">
                <span style="color:#fff; font-weight:600;">Admin</span>
            </div>
            
            <div class="nav-category">Global</div>
            <div class="nav-item" onclick="openPage('globals')" id="nav-globals">
                <span><i class="fa-solid fa-globe" style="width:20px;"></i> Social & Logo</span>
            </div>

            <div class="nav-category">Seiten</div>
            <div id="page-nav"></div>

            <div style="margin-top:auto; padding:20px;">
                <button onclick="logout()" class="pill pill--ghost pill--full" style="color:#666;">
                    <i class="fa-solid fa-sign-out-alt"></i> Abmelden
                </button>
            </div>
        </aside>

        <main>
            <header>
                <div style="display:flex; align-items:center;">
                    <button class="burger-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <h1 id="page-title" style="color:#fff; font-size:16px; font-weight:600;">Lade...</h1>
                </div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <div class="history-group" style="display:flex; gap:5px; margin-right:15px; border-right:1px solid #333; padding-right:15px;">
                        <button class="history-btn" onclick="undo()" id="btn-undo" title="Rückgängig (Strg+Z)"><i class="fa-solid fa-rotate-left"></i></button>
                        <button class="history-btn" onclick="redo()" id="btn-redo" title="Wiederholen (Strg+Y)"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>

                    <a href="/" target="_blank" class="pill pill--ghost" style="height: 38px;">
                        <i class="fa-solid fa-external-link-alt"></i> &nbsp; Website
                    </a>
                    <button onclick="saveAll()" id="save-btn" class="pill pill--primary" style="height: 38px;">
                        <i class="fa-solid fa-save"></i> &nbsp; Speichern
                    </button>
                </div>
            </header>
            <div class="editor-scroll">
                <div id="editor-container" class="editor-container"></div>
            </div>
        </main>
    </div>

    <script>
        // === CONFIG ===
        const pagesToScan = [
            { file: '/index.html', name: 'Startseite' },
            { file: '/leistungen.html', name: 'Leistungen' },
            { file: '/kontakt.html', name: 'Kontakt' },
            { file: '/impressum.html', name: 'Impressum' },
            { file: '/agb.html', name: 'AGB' },
            { file: '/datenschutz.html', name: 'Datenschutz' },
        ];
        
        const API = '/api/admin';
    
    // --- STATE ---
    let contentData = {};
    let pageStructure = {}; // Speichert die Sections pro Seite
    let globalFields = [];  // Globale Felder (Header/Footer)
    
    // --- HISTORY ---
    let editHistory = [];
    let historyIndex = -1;
    let isInternalUpdate = false;

    function addToHistory(newState) {
        if(isInternalUpdate) return;
        if(historyIndex < editHistory.length - 1) editHistory = editHistory.slice(0, historyIndex + 1);
        editHistory.push(JSON.parse(JSON.stringify(newState)));
        historyIndex++;
        updateHistoryBtns();
    }

    function undo() {
        if(historyIndex > 0) {
            historyIndex--;
            restoreHistory();
        }
    }
    function redo() {
        if(historyIndex < editHistory.length - 1) {
            historyIndex++;
            restoreHistory();
        }
    }
    function restoreHistory() {
        isInternalUpdate = true;
        contentData = JSON.parse(JSON.stringify(editHistory[historyIndex]));
        
        // Refresh Current View without full reload
        const activeNav = document.querySelector('.nav-item.active');
        if(activeNav) {
            const pageId = activeNav.id.replace('nav-p-', '');
            if(pageId === 'nav-globals') openPage('globals'); 
            else openPage(parseInt(pageId));
        }
        
        isInternalUpdate = false;
        updateHistoryBtns();
    }
    function updateHistoryBtns() {
        document.getElementById('btn-undo').disabled = historyIndex <= 0;
        document.getElementById('btn-redo').disabled = historyIndex >= editHistory.length - 1;
    }

    // --- AUTH ---
    function checkAuth() {
        if(localStorage.getItem('token')) {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('app').style.display = 'flex'; 
            initDashboard();
        }
    }
    async function doLogin() {
        const btn = document.getElementById('login-btn');
        const pwd = document.getElementById('password-input').value;
        const old = btn.innerText; btn.innerText="...";
        try {
            const res = await fetch(`${API}?action=login`, { method:'POST', body:JSON.stringify({password: pwd, email:'admin'}) });
            const data = await res.json();
            if(res.ok && data.success) { localStorage.setItem('token', data.token); checkAuth(); }
            else { document.getElementById('login-error').innerText = "Falsches Passwort"; btn.innerText=old; }
        } catch(e) { btn.innerText=old; }
    }
    function logout() { localStorage.removeItem('token'); location.reload(); }

    // === CORE LOGIC ===
    async function initDashboard() {
        try {
            const res = await fetch(API);
            contentData = await res.json();
        } catch(e) { contentData = {}; }
        
        await scanAllPages();
        addToHistory(contentData); 
        
        // Shortcuts
        document.addEventListener('keydown', (e) => {
            if((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
        });

        openPage('globals'); 
        
        setTimeout(() => {
            const t = document.getElementById('welcome-toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }, 500);
    }

// --- INTELLIGENT SCANNER ---
    async function scanAllPages() {
        const nav = document.getElementById('page-nav');
        nav.innerHTML = '';
        pageStructure = {};
        globalFields = [];
        const seenGlobals = new Set();

        for (let i = 0; i < pagesToScan.length; i++) {
            const page = pagesToScan[i];
            try {
                const res = await fetch(page.file);
                const text = await res.text();
                const doc = new DOMParser().parseFromString(text, 'text/html');
                
                // 1. Globals Scan
                doc.querySelectorAll('[data-edit^="global_"]').forEach(el => {
                    const key = el.getAttribute('data-edit');
                    if(!seenGlobals.has(key)) {
                        seenGlobals.add(key);
                        globalFields.push(analyzeElement(el));
                    }
                });

                // 2. Section Scan
                const sections = [];
                const allSections = doc.querySelectorAll('section');
                
                // Fallback für Seiten ohne Sections
                if(allSections.length === 0) {
                    const fields = [];
                    doc.querySelectorAll('[data-edit]').forEach(el => {
                        if(!el.getAttribute('data-edit').startsWith('global_')) {
                            fields.push(analyzeElement(el));
                        }
                    });
                    if(fields.length > 0) sections.push({ title: 'INHALT', fields });
                } else {
                    // Sections durchgehen
                    allSections.forEach((sec, idx) => {
                        const fields = [];

                        // FIX: Prüfen, ob die Section SELBST ein bearbeitbares Feld ist (z.B. Hintergrundbild)
                        if(sec.hasAttribute('data-edit') && !sec.getAttribute('data-edit').startsWith('global_')) {
                            fields.push(analyzeElement(sec));
                        }

                        // Dann den INHALT der Section scannen
                        sec.querySelectorAll('[data-edit]').forEach(el => {
                            if(!el.getAttribute('data-edit').startsWith('global_')) {
                                fields.push(analyzeElement(el));
                            }
                        });

                        if(fields.length > 0) {
                            let title = sec.getAttribute('id') || `SECTION ${idx + 1}`;
                            const h2 = sec.querySelector('h2, .sectionHead h2, .h2');
                            if(h2 && h2.innerText.trim().length > 0 && h2.innerText.trim().length < 30) {
                                title = h2.innerText.trim().toUpperCase();
                            } else {
                                title = title.replace(/-/g, ' ').toUpperCase();
                                if(title.includes('HERO')) title = 'HERO BEREICH';
                                if(title.includes('PAKETE')) title = 'PAKETE & PREISE';
                                if(title.includes('FAQ')) title = 'HÄUFIGE FRAGEN';
                            }
                            sections.push({ title, fields });
                        }
                    });
                }

                pageStructure[i] = sections;

                // Nav Item
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.id = `nav-p-${i}`;
                div.onclick = () => { 
                    openPage(i); 
                    if(window.innerWidth <= 768) toggleSidebar(); 
                };
                const totalFields = sections.reduce((acc, s) => acc + s.fields.length, 0);
                div.innerHTML = `<span><i class="fa-regular fa-file-lines" style="margin-right:10px;"></i> ${page.name}</span> <span class="badge-count">${totalFields}</span>`;
                nav.appendChild(div);

            } catch(e) { console.error(e); }
        }
    }

    function analyzeElement(el) {
        const key = el.getAttribute('data-edit');
        let type = 'text';
        let defaultVal = el.innerHTML.trim();

        const cfEmail = el.querySelector('.__cf_email__');
        if(cfEmail) {
            defaultVal = cfDecode(cfEmail.getAttribute('data-cfemail'));
        }

        // TYPE DETECTION (WICHTIG!)
        // 1. Ist es ein IMG Tag?
        if(el.tagName === 'IMG') {
            type = 'image'; 
            defaultVal = el.getAttribute('src');
        } 
        // 2. Ist es explizit als background-image markiert? (data-type="bg")
        else if(el.getAttribute('data-type') === 'bg') {
            type = 'image';
            const match = (el.getAttribute('style')||'').match(/url\(['"]?(.*?)['"]?\)/);
            if(match) defaultVal = match[1];
        } 
        // 3. Iframe (Video)
        else if(el.tagName === 'IFRAME') {
            type = 'text'; 
            defaultVal = el.getAttribute('src');
        } 
        // 4. Link (A-Tag)
        else if(el.tagName === 'A') {
            type = 'link'; 
            defaultVal = el.getAttribute('href'); 
            
            if(defaultVal && defaultVal.includes('/cdn-cgi/l/email-protection#')) {
                const encoded = defaultVal.split('#')[1];
                defaultVal = 'mailto:' + cfDecode(encoded);
            }

            if(key.includes('whatsapp') || key.includes('insta') || key.includes('youtube') || key.includes('tiktok')) type = 'social';
        } 
        // 5. Fallback: Text
        else {
            type = 'formatted_text';
        }

        return { key, type, defaultVal };
    }

    function openPage(id) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const container = document.getElementById('editor-container');
        container.innerHTML = '';

        if(id === 'globals') {
            document.getElementById('nav-globals').classList.add('active');
            document.getElementById('page-title').innerText = "Globale Einstellungen";
            renderSection({ title: 'GLOBALE ELEMENTE (Header / Footer)', fields: globalFields }, container);
            if(window.innerWidth <= 768) toggleSidebar();
        } else {
            document.getElementById(`nav-p-${id}`).classList.add('active');
            document.getElementById('page-title').innerText = pagesToScan[id].name;
            
            const sections = pageStructure[id];
            if(!sections || sections.length === 0) {
                 container.innerHTML = '<div style="color:#444; text-align:center; padding-top:40px;">Keine bearbeitbaren Bereiche gefunden.</div>';
                 return;
            }

            sections.forEach(sec => renderSection(sec, container));
        }
    }

    function renderSection(sectionData, container) {
        if(sectionData.fields.length === 0) return;

        const card = document.createElement('div');
        card.className = 'cms-card';
        card.innerHTML = `<div class="cms-card-header"><span>${sectionData.title}</span></div>`;
        
        const body = document.createElement('div');
        body.className = 'cms-card-body';

        let lastGroup = "";

        sectionData.fields.forEach(f => {
            let currentGroup = null;

            if(f.key.includes('pkt_basic')) currentGroup = "BASIC PAKET";
            else if(f.key.includes('pkt_premium')) currentGroup = "PREMIUM PAKET";
            else if(f.key.includes('pkt_luxus')) currentGroup = "LUXUS PAKET";
            else if(f.key.includes('_cat_')) currentGroup = "NEUE KATEGORIE (ÜBERSCHRIFT)";
            else if(f.key.startsWith('svc_')) {
                 if(f.key.includes('_basics_')) currentGroup = "SERVICE: BASICS";
                 else if(f.key.includes('_lack_')) currentGroup = "SERVICE: LACK";
                 else if(f.key.includes('_schutz_')) currentGroup = "SERVICE: SCHUTZ";
                 else if(f.key.includes('_innen_')) currentGroup = "SERVICE: INNENRAUM";
            }
            else {
                const numMatch = f.key.match(/_(\d+)(_|$)/);
                if(numMatch) currentGroup = `GRUPPE ${numMatch[1]}`;
            }

            if(currentGroup && currentGroup !== lastGroup) {
                body.insertAdjacentHTML('beforeend', `<div class="cms-separator">${currentGroup}</div>`);
                lastGroup = currentGroup;
            }

            renderField(f, body);
        });

        card.appendChild(body);
        container.appendChild(card);
    }

    function renderField(field, parent) {
        if(field.key.includes('_link_hidden')) return; 

        let val = contentData[field.key];
        if(val === undefined || val === null) val = field.defaultVal || '';

        // Labels
        let labelText = field.key;
        const parts = field.key.split('_');
        if(parts.length >= 3) labelText = parts.slice(2).join(' ').toUpperCase();
        else labelText = labelText.toUpperCase().replace(/_/g, ' ');
        
        // Spezifische Labels
        if(field.key.includes('global_telefon_link')) labelText = 'TELEFONNUMMER (WIRD GEWÄHLT)';
        else if(field.key.includes('global_telefon_text')) labelText = 'TELEFON (ANZEIGE AUF WEBSITE)';
        else if(field.key.includes('global_email_link')) labelText = 'EMAIL ADRESSE (EMPFÄNGER)';
        else if(field.key.includes('global_email_text')) labelText = 'EMAIL (ANZEIGE AUF WEBSITE)';
        else if(field.key.includes('global_adresse')) labelText = 'ADRESSE';
        else if(field.key.includes('global_footer_claim')) labelText = 'FOOTER TEXT (UNTEN)';
        else if(field.key.includes('global_logo')) labelText = 'FIRMENLOGO';
        else if(field.key.includes('global_whatsapp')) labelText = 'WHATSAPP LINK';
        else if(field.key.includes('global_insta')) labelText = 'INSTAGRAM LINK';
        else if(field.key.includes('global_tiktok')) labelText = 'TIKTOK LINK';
        else if(field.key.includes('global_youtube')) labelText = 'YOUTUBE LINK';
        
        else if(field.key.includes('bg')) labelText = 'HINTERGRUND BILD';
        else if(field.type === 'link') labelText = 'LINK ZIEL (URL)';

        const wrap = document.createElement('div');
        wrap.className = 'cms-field-wrap';
        
        let html = `<label class="cms-label-small">${labelText}</label>`;

        // === RENDER TYPES ===
        if(field.key === 'global_hero_video') {
             let iconSrc = '../youtube.png';
             html += `<div class="social-input-wrap"><div class="social-icon-box"><img src="${iconSrc}" onerror="this.style.display='none'"></div><input type="text" value="${val.replace(/"/g, '&quot;')}" onchange="updateVal('${field.key}', this.value)" placeholder="https://www.youtube.com/embed/..."></div>`;
        } 
        else if(field.type === 'social') {
            let iconSrc = '';
            if(field.key.includes('whatsapp')) iconSrc = '../whatsapp.png';
            if(field.key.includes('insta')) iconSrc = '../instagram.png';
            if(field.key.includes('youtube')) iconSrc = '../youtube.png';
            if(field.key.includes('tiktok')) iconSrc = '../tiktok.png';
            html += `<div class="social-input-wrap"><div class="social-icon-box"><img src="${iconSrc}" onerror="this.style.display='none'"></div><input type="text" value="${val.replace(/"/g, '&quot;')}" onchange="updateVal('${field.key}', this.value)" placeholder="https://..."></div>`;
        } 
        else if(field.type === 'link') {
            html += `<input type="text" value="${val.replace(/"/g, '&quot;')}" oninput="updateVal('${field.key}', this.value)" class="cms-input" placeholder="https://... oder tel:...">`;
        } 
        else if(field.type === 'image') {
            let prevSrc = val;
            if(val && !val.startsWith('http') && !val.startsWith('data:') && !val.startsWith('../') && !val.startsWith('/')) prevSrc = '../' + val.replace(/^\.\//, '');
            
            // Fix für leere Bilder
            const imgStyle = `width:60px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #333; background:#000;`;
            
            html += `
            <div style="display:flex; gap:15px; align-items:center;">
                <img src="${prevSrc}" id="preview-${field.key}" style="${imgStyle}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM1NTUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIzIiB5PSIzIiB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjxjaXJjbGUgY3g9IjguNSIgY3k9IjguNSIgcj0iMS41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSIvPjwvc3ZnPg=='">
                <div style="flex:1; display:flex; gap:10px;">
                    <label class="pill pill--ghost" style="font-size:12px; padding:0 12px; height:36px; cursor:pointer;">
                        Upload <input type="file" onchange="handleImage('${field.key}', this)" style="display:none;">
                    </label>
                    <button onclick="openLibrary('${field.key}')" class="pill pill--ghost" style="font-size:12px; padding:0 12px; height:36px;">Bibliothek</button>
                </div>
            </div>`;
        } 
        else {
            html += `<div class="format-toolbar"><button class="format-btn" onmousedown="formatText('bold', event)" title="Fett"><b>B</b></button><button class="format-btn" onmousedown="formatText('italic', event)" title="Kursiv"><i>I</i></button><button class="format-btn" onmousedown="formatText('underline', event)" title="Unterstrichen"><u>U</u></button></div><div class="cms-editor" contenteditable="true" onblur="updateVal('${field.key}', this.innerHTML)">${val}</div>`;
        }
        wrap.innerHTML = html;
        parent.appendChild(wrap);
    }

    // --- HELPERS ---
    let debounceTimer;
    function updateVal(k, v) { 
        contentData[k] = v;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => addToHistory(contentData), 800);
    }
    function formatText(cmd, e) { e.preventDefault(); document.execCommand(cmd, false, null); }
    function cfDecode(email) {
        try {
            let r = "";
            let k = parseInt(email.substr(0, 2), 16);
            for (let i = 2; i < email.length; i += 2) r += String.fromCharCode(parseInt(email.substr(i, 2), 16) ^ k);
            return r;
        } catch(e) { return ""; }
    }
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('mobile-overlay').classList.toggle('active');
    }

    // --- MEDIA ---
    function handleImage(k, inp) {
        const f = inp.files[0];
        if(!f || f.size > 15*1024*1024) return alert('Max 15MB');
        const r = new FileReader();
        r.onload = e => { applyImage(k, e.target.result); addToHistory(contentData); };
        r.readAsDataURL(f);
    }
    function applyImage(k, src) {
        contentData[k] = src;
        let d = src;
        if(!src.startsWith('data:') && !src.startsWith('http') && !src.startsWith('/')) d = '../'+src.replace(/^\.\//,'');
        const el = document.getElementById(`preview-${k}`);
        if(el) el.src = d;
    }
    function openLibrary(k) {
        currentImageKey = k;
        const grid = document.getElementById('media-grid');
        grid.innerHTML = '';
        const images = new Set();
        
        // 1. Sammle Bilder aus der gescannten Struktur
        Object.values(pageStructure).forEach(sections => {
            sections.forEach(sec => {
                sec.fields.forEach(f => { if(f.type==='image' && f.defaultVal) images.add(f.defaultVal); });
            });
        });
        
        // 2. Sammle Bilder aus den Global Fields
        globalFields.forEach(f => { if(f.type === 'image' && f.defaultVal) images.add(f.defaultVal); });

        // 3. Sammle Bilder aus den gespeicherten Daten (für neue Uploads)
        Object.values(contentData).forEach(v => { 
            if(typeof v==='string' && v.startsWith('data:image')) images.add(v); 
        });
        
        if(images.size === 0) {
            grid.innerHTML = '<div style="color:#666; font-size:13px; padding:20px;">Noch keine Bilder vorhanden.</div>';
        } else {
            images.forEach(src => {
                let d = src;
                if(!src.startsWith('data:') && !src.startsWith('http')) {
                    if(!src.startsWith('../') && !src.startsWith('/')) d = '../' + src.replace(/^\.\//, '');
                }
                const div = document.createElement('img');
                div.src = d; div.className = 'media-item';
                div.style.width='100%'; div.style.aspectRatio='1'; div.style.objectFit='cover'; div.style.cursor='pointer';
                div.onclick = () => { applyImage(currentImageKey, src); addToHistory(contentData); document.getElementById('media-modal').style.display='none'; };
                grid.appendChild(div);
            });
        }
        document.getElementById('media-modal').style.display='flex';
    }
    function closeLibrary() { document.getElementById('media-modal').style.display='none'; }

    // --- SAVE ---
    async function saveAll() {
        const btn = document.getElementById('save-btn');
        const old = btn.innerText; btn.innerText = '...';
        const res = await fetch(`${API}?action=save`, {
            method:'POST', headers:{'Authorization':localStorage.getItem('token')},
            body:JSON.stringify(contentData)
        });
        if(res.ok) { 
            btn.innerHTML = '<i class="fa-solid fa-check"></i> OK'; 
            setTimeout(()=>btn.innerText=old, 1500); 
        } else { btn.innerText = 'Error'; }
    }

    // Init
    let currentImageKey = null;
    checkAuth();
</script>
