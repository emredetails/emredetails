<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- DESIGN UPDATE: GRAU STATT BLAU --- */
        body { overflow: hidden; display: flex; height: 100vh; background: #0b0c10; }
        
        /* Sidebar */
        aside {
            width: 280px; background: #111; border-right: 1px solid #222;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header {
            height: 70px; display: flex; align-items: center; padding: 0 24px;
            border-bottom: 1px solid #222;
        }
        .nav-category {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #555;
            padding: 20px 20px 10px; font-weight: 700;
        }
        .nav-item {
            padding: 12px 20px; margin: 2px 10px; border-radius: 8px;
            color: #888; font-size: 14px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-item:hover { background: #222; color: #fff; }
        .nav-item.active { background: #333; color: #fff; font-weight: 500; }
        .badge-count { background: #000; padding: 2px 8px; border-radius: 6px; font-size: 11px; color: #555; }

        /* Main Area */
        main {
            flex: 1; display: flex; flex-direction: column;
            background: #0f1115; /* Reines Dunkelgrau, kein Blau mehr */
            position: relative;
        }
        header {
            height: 70px; border-bottom: 1px solid #222; display: flex; 
            align-items: center; justify-content: space-between; padding: 0 40px;
            background: #111;
        }

        /* --- EDITING UI: GROUPING & CARDS --- */
        .editor-scroll { flex: 1; overflow-y: auto; padding: 40px; }
        .editor-container { max-width: 800px; margin: 0 auto; padding-bottom: 100px; }

        /* Das ist die Box für eine Gruppe (z.B. "Paket 1") */
        .cms-card {
            background: #16181c; border: 1px solid #2a2d35;
            border-radius: 12px; margin-bottom: 24px; overflow: hidden;
        }
        .cms-card-header {
            background: #1c1f24; padding: 12px 20px;
            border-bottom: 1px solid #2a2d35;
            font-size: 13px; font-weight: 700; letter-spacing: 0.5px; 
            color: #bbb; text-transform: uppercase;
            display: flex; justify-content: space-between; align-items: center;
        }
        .cms-card-body { padding: 20px; display: grid; gap: 20px; }

        /* Inputs */
        .cms-field-wrap { position: relative; }
        .cms-label-small {
            display: block; font-size: 11px; color: #555; margin-bottom: 6px; 
            text-transform: uppercase; font-weight: 600;
        }
        .cms-input, .cms-textarea {
            width: 100%; background: #0a0b0d; border: 1px solid #333;
            color: #ddd; padding: 10px 12px; border-radius: 8px;
            font-family: inherit; font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .cms-input:focus, .cms-textarea:focus { border-color: #555; background: #000; }
        .cms-textarea { min-height: 80px; resize: vertical; line-height: 1.5; }

        /* Login & Modal Styles bleiben gleich, nur Farben angepasst */
        #login-overlay, #media-modal { background: rgba(5,5,5,0.95); }
        .media-item { border: 2px solid #333; }
        
        .hidden { display: none !important; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="login-overlay" style="position:fixed; inset:0; z-index:9999; display:grid; place-items:center;">
        <div style="background:#1a1a1a; padding:40px; border-radius:12px; border:1px solid #333; text-align:center; width:350px;">
            <h2 style="color:#fff; margin-bottom:20px;">Admin Login</h2>
            <div id="login-step-1">
                <input type="email" id="email-input" placeholder="Email" class="cms-input" style="margin-bottom:15px; text-align:center;">
                <button onclick="requestLogin()" class="pill pill--primary pill--full">Code senden</button>
            </div>
            <div id="login-step-2" class="hidden">
                <input type="text" id="code-input" placeholder="123456" class="cms-input" style="margin-bottom:15px; text-align:center; font-size:20px; letter-spacing:3px;">
                <button onclick="verifyLogin()" class="pill pill--primary pill--full">Einloggen</button>
            </div>
            <p id="login-error" style="color:#ff5555; margin-top:10px; font-size:13px;"></p>
        </div>
    </div>

    <div id="media-modal" style="position:fixed; inset:0; z-index:9000; display:none; flex-direction:column; padding:40px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="color:#fff;">Bild auswählen</h2>
            <button onclick="closeLibrary()" style="background:none; border:none; color:#aaa; cursor:pointer;">Schließen</button>
        </div>
        <div id="media-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:15px; overflow:auto;"></div>
    </div>

    <div id="app" class="hidden" style="width:100%;">
        <aside>
            <div class="sidebar-header">
                <img src="https://cdn.prod.website-files.com/67f11742c5f3bcc352d799cc/67f14fa65b0383b0565fd742_emre%20details%20blue%20transparent%20bg.png" 
                     style="max-height:40px; width:auto; margin-right:15px;">
                <span style="color:#fff; font-weight:600;">Admin</span>
            </div>
            
            <div class="nav-category">Global</div>
            <div class="nav-item" onclick="openPage('globals')" id="nav-globals">
                <span><i class="fa-solid fa-globe" style="width:20px;"></i> Einstellungen</span>
            </div>

            <div class="nav-category">Seiten</div>
            <div id="page-nav"></div>

            <div style="margin-top:auto; padding:20px;">
                <button onclick="logout()" class="pill pill--ghost pill--full" style="color:#555;">Abmelden</button>
            </div>
        </aside>

        <main>
            <header>
                <h1 id="page-title" style="color:#fff; font-size:18px;">Lade...</h1>
                <div style="display:flex; gap:10px;">
                    <a href="/" target="_blank" class="pill pill--ghost">Website</a>
                    <button onclick="saveAll()" id="save-btn" class="pill pill--primary">Speichern</button>
                </div>
            </header>
            <div class="editor-scroll">
                <div id="editor-container" class="editor-container"></div>
            </div>
        </main>
    </div>

    <script>
        const pagesToScan = [
            { file: '/index.html', name: 'Startseite' },
            { file: '/leistungen.html', name: 'Leistungen & Preise' },
        ];
        
        const API = '/api/admin';
        let contentData = {};
        let scannedFields = {}; 
        let globalFields = []; // Hier sammeln wir alles was global_ heißt
        let currentImageKey = null;

        // --- AUTH & INIT ---
        function checkAuth() {
            if(localStorage.getItem('token')) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('app').style.display = 'flex'; 
                initDashboard();
            }
        }
        async function requestLogin() {
            const email = document.getElementById('email-input').value;
            const res = await fetch(`${API}?action=login`, { method:'POST', body: JSON.stringify({email})});
            if(res.ok) { document.getElementById('login-step-1').classList.add('hidden'); document.getElementById('login-step-2').classList.remove('hidden'); }
            else document.getElementById('login-error').innerText = "Zugriff verweigert.";
        }
        async function verifyLogin() {
            const email = document.getElementById('email-input').value;
            const code = document.getElementById('code-input').value;
            const res = await fetch(`${API}?action=verify`, { method:'POST', body: JSON.stringify({email, code})});
            const data = await res.json();
            if(data.success) { localStorage.setItem('token', data.token); checkAuth(); }
            else document.getElementById('login-error').innerText = "Code ungültig.";
        }
        function logout() { localStorage.removeItem('token'); location.reload(); }

        // --- CORE LOGIC ---
        async function initDashboard() {
            try {
                const res = await fetch(API);
                contentData = await res.json();
            } catch(e) { contentData = {}; }
            await scanPages();
            
            // Standardmäßig Globals öffnen oder erste Seite
            openPage('globals'); 
        }

        async function scanPages() {
            const nav = document.getElementById('page-nav');
            nav.innerHTML = '';
            scannedFields = {};
            globalFields = [];
            
            // Set um doppelte Globals zu vermeiden
            const seenGlobals = new Set();

            for (let i = 0; i < pagesToScan.length; i++) {
                const page = pagesToScan[i];
                try {
                    const res = await fetch(page.file);
                    const text = await res.text();
                    const doc = new DOMParser().parseFromString(text, 'text/html');
                    
                    const pageFields = [];

                    doc.querySelectorAll('[data-edit]').forEach(el => {
                        const key = el.getAttribute('data-edit');
                        let type = 'text';
                        let defaultVal = el.innerHTML.trim();

                        if(el.tagName === 'IMG') {
                            type = 'image'; defaultVal = el.getAttribute('src');
                        } else if(el.getAttribute('data-type') === 'bg') {
                            type = 'image';
                            const match = (el.getAttribute('style')||'').match(/url\(['"]?(.*?)['"]?\)/);
                            if(match) defaultVal = match[1];
                        } else if(el.tagName === 'A') {
                            // Link
                            type = 'text'; defaultVal = el.getAttribute('href');
                        } else if(el.tagName === 'TEXTAREA' || el.innerText.length > 50) {
                            type = 'textarea';
                        }

                        const fieldObj = { key, type, defaultVal };

                        // Check ob Global
                        if(key.startsWith('global_')) {
                            if(!seenGlobals.has(key)) {
                                seenGlobals.add(key);
                                globalFields.push(fieldObj);
                            }
                        } else {
                            pageFields.push(fieldObj);
                        }
                    });

                    scannedFields[i] = pageFields;

                    // Nav Render
                    const div = document.createElement('div');
                    div.className = 'nav-item';
                    div.id = `nav-p-${i}`;
                    div.onclick = () => openPage(i);
                    div.innerHTML = `<span>${page.name}</span> <span class="badge-count">${pageFields.length}</span>`;
                    nav.appendChild(div);

                } catch(e) { console.error(e); }
            }
        }

        function openPage(id) {
            // UI Update
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const container = document.getElementById('editor-container');
            container.innerHTML = '';

            let fieldsToShow = [];
            
            if(id === 'globals') {
                document.getElementById('nav-globals').classList.add('active');
                document.getElementById('page-title').innerText = "Globale Einstellungen";
                fieldsToShow = globalFields;
            } else {
                document.getElementById(`nav-p-${id}`).classList.add('active');
                document.getElementById('page-title').innerText = pagesToScan[id].name;
                fieldsToShow = scannedFields[id];
            }

            renderGroups(fieldsToShow, container);
        }

        // --- GRUPPIERUNGS LOGIK (MAGIC HAPPENS HERE) ---
        function renderGroups(fields, container) {
            if(!fields || fields.length === 0) {
                container.innerHTML = '<div style="color:#444; text-align:center;">Nichts zu bearbeiten.</div>';
                return;
            }

            // 1. Gruppieren nach Prefix (z.B. "paket_1_")
            const groups = {};
            const misc = [];

            fields.forEach(f => {
                // Suche nach Muster "wort_zahl_" oder "wort_" am Anfang
                // Wir nehmen einfach alles vor dem zweiten Unterstrich als Gruppe, wenn vorhanden
                const parts = f.key.split('_');
                if(parts.length >= 2) {
                    // Beispiel: paket_1_titel -> Gruppe "paket_1"
                    // Beispiel: leistungen_hero_text -> Gruppe "leistungen_hero"
                    // Wir versuchen intelligente Gruppennamen zu bilden
                    let groupKey = parts[0]; 
                    if(!isNaN(parts[1])) groupKey += `_${parts[1]}`; // Nimmt Zahl mit (paket_1)
                    
                    if(!groups[groupKey]) groups[groupKey] = [];
                    groups[groupKey].push(f);
                } else {
                    misc.push(f);
                }
            });

            // 2. Gruppen rendern
            for (const [gKey, gFields] of Object.entries(groups)) {
                // Wenn Gruppe nur 1 Feld hat, zu Misc verschieben (lohnt keine Box)
                if(gFields.length === 1) {
                    renderField(gFields[0], container);
                } else {
                    const card = document.createElement('div');
                    card.className = 'cms-card';
                    
                    // Schönen Titel generieren (paket_1 -> PAKET 1)
                    const title = gKey.replace(/_/g, ' ').toUpperCase();
                    
                    card.innerHTML = `<div class="cms-card-header"><span>${title}</span></div>`;
                    const body = document.createElement('div');
                    body.className = 'cms-card-body';
                    
                    gFields.forEach(f => renderField(f, body));
                    card.appendChild(body);
                    container.appendChild(card);
                }
            }

            // 3. Einzelne Felder rendern
            if(misc.length > 0) {
                const miscCard = document.createElement('div');
                miscCard.className = 'cms-card';
                miscCard.innerHTML = `<div class="cms-card-header"><span>Sonstiges</span></div>`;
                const miscBody = document.createElement('div');
                miscBody.className = 'cms-card-body';
                misc.forEach(f => renderField(f, miscBody));
                miscCard.appendChild(miscBody);
                container.appendChild(miscCard);
            }
        }

        function renderField(field, parent) {
            let val = contentData[field.key];
            if(val === undefined || val === null) val = field.defaultVal || '';

            // Clean Label: "paket_1_titel" -> "TITEL" (da Gruppe schon Paket 1 heißt)
            // Wir entfernen den Gruppen-Teil aus dem Label für saubere Optik
            let labelParts = field.key.split('_');
            let labelText = field.key.toUpperCase().replace(/_/g, ' ');
            
            // Einfache Logik: Wenn Label sehr lang ist, versuchen wir es zu kürzen
            if(labelParts.length > 2) {
                labelText = labelParts.slice(2).join(' ').toUpperCase(); // paket_1_titel -> TITEL
            } else if(labelParts.length === 2) {
                labelText = labelParts[1].toUpperCase();
            }

            const wrap = document.createElement('div');
            wrap.className = 'cms-field-wrap';
            
            let html = `<label class="cms-label-small">${labelText}</label>`;

            if(field.type === 'textarea') {
                html += `<textarea oninput="updateVal('${field.key}', this.value)" class="cms-textarea">${val}</textarea>`;
            } else if(field.type === 'image') {
                // Bild Logik
                let prevSrc = val;
                if(val && !val.startsWith('http') && !val.startsWith('data:')) {
                    if(!val.startsWith('../') && !val.startsWith('/')) prevSrc = '../' + val.replace(/^\.\//, '');
                }
                html += `
                    <div style="display:flex; gap:15px; align-items:center;">
                        <img src="${prevSrc}" id="preview-${field.key}" style="width:60px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #333; background:#000;">
                        <div style="flex:1; display:flex; gap:10px;">
                            <label class="pill pill--ghost" style="font-size:12px; padding:0 12px; height:36px; cursor:pointer;">
                                Upload
                                <input type="file" onchange="handleImage('${field.key}', this)" style="display:none;">
                            </label>
                            <button onclick="openLibrary('${field.key}')" class="pill pill--ghost" style="font-size:12px; padding:0 12px; height:36px;">Bibliothek</button>
                        </div>
                    </div>
                `;
            } else {
                html += `<input type="text" value="${val.replace(/"/g, '&quot;')}" oninput="updateVal('${field.key}', this.value)" class="cms-input">`;
            }
            
            wrap.innerHTML = html;
            parent.appendChild(wrap);
        }

        function updateVal(k, v) { contentData[k] = v; }
        
        // --- BILDER & LIBRARY (Copy Paste Logik) ---
        function handleImage(k, inp) {
            const f = inp.files[0];
            if(!f || f.size > 8*1024*1024) return alert('Max 8MB');
            const r = new FileReader();
            r.onload = e => applyImage(k, e.target.result);
            r.readAsDataURL(f);
        }
        function applyImage(k, src) {
            contentData[k] = src;
            let d = src;
            if(!src.startsWith('data:') && !src.startsWith('http') && !src.startsWith('/')) d = '../'+src.replace(/^\.\//,'');
            document.getElementById(`preview-${k}`).src = d;
        }
        function openLibrary(k) {
            currentImageKey = k;
            const grid = document.getElementById('media-grid');
            grid.innerHTML = '';
            // Sammeln
            const images = new Set();
            [globalFields, ...Object.values(scannedFields)].flat().forEach(f => { if(f.type === 'image' && f.defaultVal) images.add(f.defaultVal); });
            Object.values(contentData).forEach(v => { if(typeof v==='string' && v.startsWith('data:image')) images.add(v); });
            
            images.forEach(src => {
                let d = src;
                if(!src.startsWith('data:') && !src.startsWith('http')) {
                    if(!src.startsWith('../') && !src.startsWith('/')) d = '../' + src.replace(/^\.\//, '');
                }
                const div = document.createElement('img');
                div.src = d; div.className = 'media-item';
                div.style.width='100%'; div.style.aspectRatio='1'; div.style.objectFit='cover'; div.style.cursor='pointer';
                div.onclick = () => { applyImage(currentImageKey, src); document.getElementById('media-modal').style.display='none'; };
                grid.appendChild(div);
            });
            document.getElementById('media-modal').style.display='flex';
        }
        function closeLibrary() { document.getElementById('media-modal').style.display='none'; }

        async function saveAll() {
            const btn = document.getElementById('save-btn');
            const old = btn.innerText; btn.innerText = '...';
            const res = await fetch(`${API}?action=save`, {
                method:'POST', headers:{'Authorization':localStorage.getItem('token')},
                body:JSON.stringify(contentData)
            });
            if(res.ok) { btn.innerText = 'OK'; setTimeout(()=>btn.innerText=old, 1500); }
            else { btn.innerText = 'Error'; }
        }

        checkAuth();
    </script>
</body>
</html>
