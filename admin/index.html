<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmreDetails | Admin Dashboard</title>
    
    <link rel="stylesheet" href="../style.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- DASHBOARD SPECIFIC LAYOUT --- */        
        body {
            overflow: hidden; /* Scrollen nur im Main Bereich */
            display: flex;
            height: 100vh;
        }

        /* LOGIN SCREEN */
        #login-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg0);
            display: grid; place-items: center;
        }
        .login-card {
            width: 100%; max-width: 400px;
            background: var(--card);
            backdrop-filter: blur(var(--blur));
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        /* SIDEBAR */
        aside {
            width: 280px;
            background: rgba(5, 9, 20, 0.6); /* --bg1 mit Transparenz */
            border-right: 1px solid var(--stroke);
            backdrop-filter: blur(20px);
            display: flex; flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            height: 80px; display: flex; align-items: center; padding: 0 24px;
            border-bottom: 1px solid var(--stroke);
            font-weight: 600; letter-spacing: 0.5px; color: var(--text);
        }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 20px 10px; }
        .nav-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; margin-bottom: 4px;
            border-radius: 14px;
            color: var(--muted);
            font-size: 14px;
            transition: all 0.2s var(--ease);
            cursor: pointer;
            border: 1px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: var(--text); }
        .nav-item.active {
            background: var(--card2);
            border-color: var(--stroke);
            color: var(--text);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .badge-count {
            background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 8px; font-size: 11px;
        }

        /* MAIN CONTENT */
        main {
            flex: 1; display: flex; flex-direction: column;
            background: radial-gradient(circle at top right, rgba(50, 120, 255, 0.05), transparent 40%);
            position: relative;
        }
        header {
            height: 80px; border-bottom: 1px solid var(--stroke);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px;
            background: rgba(2, 4, 8, 0.8); /* --bg0 */
            backdrop-filter: blur(10px);
        }
        .editor-scroll {
            flex: 1; overflow-y: auto; padding: 40px;
        }
        .editor-container { max-width: 900px; margin: 0 auto; padding-bottom: 100px; }

        /* FORM ELEMENTS (Custom Style based on your CSS) */
        .cms-group {
            margin-bottom: 30px;
            background: var(--card); /* Glass Card */
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow2);
        }
        .cms-label {
            display: block; margin-bottom: 10px;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--muted); font-weight: 600;
        }
        
        /* Inputs im Style deiner Website */
        .cms-input, .cms-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 14px 16px;
            border-radius: 14px;
            font-family: inherit; font-size: 15px; line-height: 1.5;
            transition: border-color 0.2s;
            outline: none;
        }
        .cms-input:focus, .cms-textarea:focus {
            border-color: var(--stroke2);
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 2px rgba(100, 140, 255, 0.1);
        }
        .cms-textarea { min-height: 120px; resize: vertical; }

        /* Image Upload */
        .img-preview-box {
            position: relative; width: 100%; height: 200px;
            border-radius: 14px; overflow: hidden;
            background: rgba(0,0,0,0.3);
            border: 1px dashed var(--stroke);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 14px;
        }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        input[type="file"] { color: var(--muted); font-size: 14px; }

        /* Utility */
        .hidden { display: none !important; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- MEDIATHEK MODAL --- */
#media-modal {
    position: fixed; inset: 0; z-index: 10000;
    background: rgba(2, 4, 8, 0.95); backdrop-filter: blur(10px);
    display: none; flex-direction: column; padding: 40px;
}
.media-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 20px; overflow-y: auto; padding-bottom: 40px;
}
.media-item-wrap { position: relative; group; cursor: pointer; }
.media-item {
    width: 100%; aspect-ratio: 1/1; object-fit: cover;
    border-radius: 12px; border: 2px solid rgba(255,255,255,0.1);
    transition: all 0.2s; background: #000;
}
.media-item:hover { border-color: #3278ff; transform: scale(1.05); }
.close-modal {
    position: absolute; top: 20px; right: 20px;
    background: rgba(255,255,255,0.1); color: white;
    border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;
}
.media-badge {
    position: absolute; bottom: 4px; right: 4px; font-size: 10px;
    background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px;
}
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <div class="brand" style="justify-content: center; margin-bottom: 30px;">
                <span class="h2">Admin Login</span>
            </div>
            
            <div id="login-step-1">
                <input type="email" id="email-input" placeholder="info@emredetails.de" class="cms-input" style="text-align: center; margin-bottom: 16px;">
                <button onclick="requestLogin()" class="pill pill--primary pill--full pill--lg">Code anfordern</button>
            </div>

            <div id="login-step-2" class="hidden">
                <p class="sub" style="margin-bottom: 16px;">Code wurde gesendet!</p>
                <input type="text" id="code-input" placeholder="123456" class="cms-input" style="text-align: center; margin-bottom: 16px; font-size: 24px; letter-spacing: 4px;">
                <button onclick="verifyLogin()" class="pill pill--good pill--full pill--lg" style="background: rgba(50, 200, 120, 0.2); border-color: rgba(50, 200, 120, 0.4); color: #7BFFA8;">Einloggen</button>
            </div>
            <p id="login-error" style="color: #ff6b6b; margin-top: 14px; font-size: 14px;"></p>
        </div>
    </div>

    <div id="app" class="hidden" style="display: flex; width: 100%;">
        
        <aside>
<div class="sidebar-header">
    <img src="https://cdn.prod.website-files.com/67f11742c5f3bcc352d799cc/67f14fa65b0383b0565fd742_emre%20details%20blue%20transparent%20bg.png" 
         alt="Logo" 
         style="max-height: 45px; width: auto; max-width: 100%; margin-right: 15px;">
    
    <span style="font-size: 20px; font-weight: 600; letter-spacing: 0.5px; color: var(--text);">Admin</span>
</div>
            <nav class="sidebar-nav" id="page-nav">
                </nav>
            <div style="padding: 20px; border-top: 1px solid var(--stroke);">
                <button onclick="logout()" class="pill pill--ghost pill--full">
                    <i class="fa-solid fa-sign-out-alt"></i> &nbsp; Abmelden
                </button>
            </div>
        </aside>

        <main>
            <header>
                <h1 class="h2" id="current-page-title" style="font-size: 20px;">Lade...</h1>
                <div style="display: flex; gap: 12px;">
                    <a href="/" target="_blank" class="pill pill--ghost">
                        <i class="fa-solid fa-external-link-alt"></i> &nbsp; Website
                    </a>
                    <button onclick="saveAll()" id="save-btn" class="pill pill--primary">
                        <i class="fa-solid fa-save"></i> &nbsp; Änderungen speichern
                    </button>
                </div>
            </header>

            <div class="editor-scroll">
                <div id="editor-container" class="editor-container">
                    </div>
            </div>
        </main>
    </div>

<script>
        // ==========================================
        // KONFIGURATION
        // ==========================================
        const pagesToScan = [
            { file: '/index.html', name: 'Home' },
            { file: '/leistungen.html', name: 'Leistungen' },
            { file: '/kontakt.html', name: 'Kontakt' },
            { file: '/impressum.html', name: 'Impressum' },
            { file: '/agb.html', name: 'AGB' },
            { file: '/datenschutz.html', name: 'Datenschutz' },
        ];
        
        const API = '/api/admin';
    let contentData = {};
    let scannedFields = {};
    let currentImageKey = null; // Speichert, welches Feld gerade bearbeitet wird

    // --- AUTH ---
    function checkAuth() {
        if(localStorage.getItem('token')) {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('app').style.display = 'flex'; 
            initDashboard();
        }
    }

    async function requestLogin() {
        const btn = document.querySelector('#login-step-1 button');
        const originalText = btn.innerText;
        btn.innerText = "Sende...";
        
        const email = document.getElementById('email-input').value;
        const res = await fetch(`${API}?action=login`, { method:'POST', body: JSON.stringify({email})});
        
        if(res.ok) {
            document.getElementById('login-step-1').classList.add('hidden');
            document.getElementById('login-step-2').classList.remove('hidden');
        } else {
            document.getElementById('login-error').innerText = "Zugriff verweigert.";
            btn.innerText = originalText;
        }
    }

    async function verifyLogin() {
        const email = document.getElementById('email-input').value;
        const code = document.getElementById('code-input').value;
        const res = await fetch(`${API}?action=verify`, { method:'POST', body: JSON.stringify({email, code})});
        const data = await res.json();
        if(data.success) {
            localStorage.setItem('token', data.token);
            checkAuth();
        } else document.getElementById('login-error').innerText = "Code ungültig.";
    }

    function logout() { localStorage.removeItem('token'); location.reload(); }

    // --- CORE ---
    async function initDashboard() {
        try {
            const res = await fetch(API);
            contentData = await res.json();
        } catch(e) { contentData = {}; }

        await scanPages();
        if(pagesToScan.length > 0) openPage(0);
        
        // ESC Key zum Schließen der Modal
        document.addEventListener('keydown', (e) => { if(e.key === "Escape") closeLibrary(); });
    }

    async function scanPages() {
        const nav = document.getElementById('page-nav');
        nav.innerHTML = '';
        scannedFields = {};

        for (let i = 0; i < pagesToScan.length; i++) {
            const page = pagesToScan[i];
            try {
                const htmlReq = await fetch(page.file);
                const htmlText = await htmlReq.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                
                const elements = doc.querySelectorAll('[data-edit]');
                const fields = [];

                elements.forEach(el => {
                    const key = el.getAttribute('data-edit');
                    let type = 'text';
                    let defaultValue = '';

                    if(el.tagName === 'IMG') {
                        type = 'image';
                        defaultValue = el.getAttribute('src');
                    } else if(el.getAttribute('data-type') === 'bg') {
                        type = 'image';
                        const style = el.getAttribute('style') || '';
                        const match = style.match(/url\(['"]?(.*?)['"]?\)/);
                        if(match) defaultValue = match[1];
                    } else {
                        if(el.tagName === 'TEXTAREA' || el.innerText.length > 60 || el.tagName === 'P') {
                            type = 'textarea';
                        }
                        defaultValue = el.innerHTML.trim();
                    }
                    
                    let label = key.replace(/_/g, ' ').toUpperCase();
                    fields.push({ key, type, label, defaultValue });
                });

                scannedFields[i] = fields;

                // Nav Item
                const div = document.createElement('div');
                div.className = `nav-item`;
                div.id = `nav-item-${i}`;
                div.onclick = () => openPage(i);
                div.innerHTML = `
                    <span><i class="fa-regular fa-file-lines" style="margin-right:10px;"></i> ${page.name}</span> 
                    <span class="badge-count">${fields.length}</span>
                `;
                nav.appendChild(div);

            } catch (e) { console.error(e); }
        }
    }

    function openPage(index) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-item-${index}`).classList.add('active');
        document.getElementById('current-page-title').innerText = pagesToScan[index].name;
        renderFields(scannedFields[index]);
    }

    function renderFields(fields) {
        const container = document.getElementById('editor-container');
        container.innerHTML = '';

        if(!fields || fields.length === 0) {
            container.innerHTML = '<div class="sub" style="text-align:center; padding-top:40px;">Keine bearbeitbaren Felder gefunden.</div>';
            return;
        }

        fields.forEach(field => {
            let val = contentData[field.key];
            if (val === undefined || val === null) val = field.defaultValue || '';

            let inputHtml = '';

            if(field.type === 'textarea') {
                inputHtml = `<textarea oninput="updateVal('${field.key}', this.value)" class="cms-textarea">${val}</textarea>`;
            } else if(field.type === 'image') {
                // Pfad Fix für Preview
                let previewSrc = val;
                if(val && !val.startsWith('http') && !val.startsWith('data:') && !val.startsWith('../') && !val.startsWith('/')) {
                     previewSrc = '../' + val.replace(/^\.\//, '');
                }

                inputHtml = `
                    <div class="img-preview-box">
                        ${val ? `<img src="${previewSrc}" id="preview-${field.key}">` : `<span class="sub" id="msg-${field.key}">Kein Bild</span> <img id="preview-${field.key}" class="hidden">`}
                    </div>
                    <div style="display:flex; gap:10px;">
                        <label class="pill pill--primary" style="flex:1; cursor:pointer; text-align:center; display:block;">
                           <i class="fa-solid fa-upload"></i> Neu hochladen
                           <input type="file" accept="image/*" onchange="handleImage('${field.key}', this)" style="display:none;">
                        </label>
                        <button onclick="openLibrary('${field.key}')" class="pill pill--ghost" style="flex:1;">
                           <i class="fa-solid fa-images"></i> Mediathek
                        </button>
                    </div>
                    <div style="font-size:11px; color:rgba(255,255,255,0.3); margin-top:6px;">Quelle: ${val.startsWith('data:') ? 'Upload' : 'Datei'}</div>
                `;
            } else {
                const safeVal = val.replace(/"/g, '&quot;');
                inputHtml = `<input type="text" value="${safeVal}" oninput="updateVal('${field.key}', this.value)" class="cms-input">`;
            }

            const group = document.createElement('div');
            group.className = 'cms-group';
            group.innerHTML = `<label class="cms-label">${field.label}</label>${inputHtml}`;
            container.appendChild(group);
        });
    }

    function updateVal(key, val) { contentData[key] = val; }

    function handleImage(key, input) {
        const file = input.files[0];
        if(!file) return;
        // LIMIT HIER AUF 8MB ERHÖHT
        if(file.size > 15 * 1024 * 1024) { alert('Bild zu groß! Bitte unter 15MB bleiben.'); return; }
        
        const reader = new FileReader();
        reader.onload = e => {
            applyImage(key, e.target.result);
        };
        reader.readAsDataURL(file);
    }

    // --- MEDIATHEK LOGIK ---
    
    function collectImages() {
        const images = new Set();
        
        // 1. Repo Bilder (Originale)
        Object.values(scannedFields).forEach(pageFields => {
            pageFields.forEach(f => {
                if(f.type === 'image' && f.defaultValue) images.add(f.defaultValue);
            });
        });

        // 2. Uploaded Bilder (aus KV)
        Object.values(contentData).forEach(val => {
            if(typeof val === 'string' && (val.startsWith('data:image') || val.match(/\.(jpeg|jpg|gif|png|webp)$/i))) {
                images.add(val);
            }
        });

        return Array.from(images);
    }

    function openLibrary(key) {
        currentImageKey = key;
        const grid = document.getElementById('media-grid');
        grid.innerHTML = '';
        const imgs = collectImages();

        imgs.forEach(src => {
            // Preview Pfad fixen
            let displaySrc = src;
            let type = "Upload";
            if(!src.startsWith('data:') && !src.startsWith('http')) {
                type = "Repo";
                if(!src.startsWith('../') && !src.startsWith('/')) displaySrc = '../' + src.replace(/^\.\//, '');
            }

            const div = document.createElement('div');
            div.className = 'media-item-wrap';
            div.onclick = () => selectFromLibrary(src);
            div.innerHTML = `
                <img src="${displaySrc}" class="media-item">
                <span class="media-badge">${type}</span>
            `;
            grid.appendChild(div);
        });

        document.getElementById('media-modal').style.display = 'flex';
    }

    function selectFromLibrary(src) {
        applyImage(currentImageKey, src);
        closeLibrary();
    }

    function closeLibrary() {
        document.getElementById('media-modal').style.display = 'none';
        currentImageKey = null;
    }

    function applyImage(key, src) {
        contentData[key] = src;
        
        // Preview Update
        let displaySrc = src;
        if(!src.startsWith('data:') && !src.startsWith('http') && !src.startsWith('../') && !src.startsWith('/')) {
             displaySrc = '../' + src.replace(/^\.\//, '');
        }
        
        const img = document.getElementById(`preview-${key}`);
        const msg = document.getElementById(`msg-${key}`);
        if(msg) msg.classList.add('hidden');
        img.src = displaySrc;
        img.classList.remove('hidden');
        
        // Upload Button Reset (optional, clean UI)
        // const fileInput = document.querySelector(`input[onchange="handleImage('${key}', this)"]`);
        // if(fileInput) fileInput.value = '';
    }

    async function saveAll() {
        const btn = document.getElementById('save-btn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner spin"></i> &nbsp; Speichern...';
        
        const token = localStorage.getItem('token');
        const res = await fetch(`${API}?action=save`, {
            method: 'POST',
            headers: { 'Authorization': token },
            body: JSON.stringify(contentData)
        });

        if(res.ok) {
            btn.innerHTML = '<i class="fa-solid fa-check"></i> &nbsp; Gespeichert';
            btn.classList.replace('pill--primary', 'pill--good');
            btn.style.color = '#000'; 
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.replace('pill--good', 'pill--primary');
                btn.style.color = '';
            }, 2000);
        } else {
            alert('Fehler beim Speichern');
            btn.innerHTML = originalHTML;
        }
    }

    checkAuth();
</script>
    <div id="media-modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 class="h2" style="font-size:24px;">Bild auswählen</h2>
        <button onclick="closeLibrary()" class="close-modal">Schließen (ESC)</button>
    </div>
    <div id="media-grid" class="media-grid">
        </div>
</div>
</body>
</html>
