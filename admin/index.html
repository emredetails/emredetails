<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmreDetails | Admin</title>
    
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ADMIN OVERRIDES (Grau statt Blau) --- */
        body { overflow: hidden; display: flex; height: 100vh; background: #050505; }
        
        aside {
            width: 280px; background: #0f0f0f; border-right: 1px solid #222;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        main {
            flex: 1; display: flex; flex-direction: column; position: relative;
            background: #141414; /* Reines Dunkelgrau */
        }
        header {
            height: 70px; border-bottom: 1px solid #222; display: flex; 
            align-items: center; justify-content: space-between; padding: 0 40px;
            background: #0f0f0f;
        }

        /* Sidebar Items */
        .sidebar-header { height: 70px; display: flex; align-items: center; padding: 0 24px; border-bottom: 1px solid #222; }
        .nav-category { font-size: 11px; text-transform: uppercase; color: #555; padding: 20px 20px 10px; font-weight: 700; letter-spacing: 1px; }
        .nav-item {
            padding: 12px 20px; margin: 2px 10px; border-radius: 8px;
            color: #888; font-size: 14px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-item:hover { background: #222; color: #fff; }
        .nav-item.active { background: #2a2a2a; color: #fff; font-weight: 500; border-left: 3px solid #fff; }
        .badge-count { background: #000; padding: 2px 8px; border-radius: 6px; font-size: 11px; color: #555; }

        /* Editor Cards */
        .editor-scroll { flex: 1; overflow-y: auto; padding: 40px; }
        .editor-container { max-width: 800px; margin: 0 auto; padding-bottom: 100px; }

        .cms-card {
            background: #1a1a1a; border: 1px solid #333;
            border-radius: 12px; margin-bottom: 24px; overflow: hidden;
        }
        .cms-card-header {
            background: #222; padding: 12px 20px; border-bottom: 1px solid #333;
            font-size: 13px; font-weight: 700; color: #ccc; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .cms-card-body { padding: 20px; display: grid; gap: 20px; }

        /* Inputs & Toolbar */
        .cms-field-wrap { position: relative; }
        .cms-label-small { display: block; font-size: 11px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
        
        .cms-input, .cms-textarea {
            width: 100%; background: #0a0a0a; border: 1px solid #333;
            color: #ddd; padding: 10px 12px; border-radius: 8px;
            font-family: inherit; font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .cms-input:focus, .cms-textarea:focus { border-color: #666; background: #000; }
        .cms-textarea { min-height: 80px; resize: vertical; line-height: 1.5; margin-top: 4px;}

        /* Format Toolbar */
        .format-toolbar {
            display: flex; gap: 4px; margin-bottom: 4px;
        }
        .format-btn {
            background: #222; border: 1px solid #333; color: #aaa;
            width: 28px; height: 28px; border-radius: 4px; cursor: pointer;
            font-family: serif; font-size: 14px; display: grid; place-items: center;
        }
        .format-btn:hover { background: #333; color: #fff; }
        
        /* Modals & Utils */
        #login-overlay, #media-modal { background: rgba(0,0,0,0.95); }
        .hidden { display: none !important; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-overlay" style="position:fixed; inset:0; z-index:9999; display:grid; place-items:center;">
        <div style="background:#111; padding:40px; border-radius:12px; border:1px solid #333; text-align:center; width:350px;">
            <h2 style="color:#fff; margin-bottom:20px;">Admin Login</h2>
            <div id="login-step-1">
                <input type="email" id="email-input" placeholder="Email" class="cms-input" style="margin-bottom:15px; text-align:center;">
                <button onclick="requestLogin()" class="pill pill--primary pill--full">Code senden</button>
            </div>
            <div id="login-step-2" class="hidden">
                <input type="text" id="code-input" placeholder="123456" class="cms-input" style="margin-bottom:15px; text-align:center; font-size:20px; letter-spacing:3px;">
                <button onclick="verifyLogin()" class="pill pill--primary pill--full">Einloggen</button>
            </div>
            <p id="login-error" style="color:#ff5555; margin-top:10px; font-size:13px;"></p>
        </div>
    </div>

    <div id="media-modal" style="position:fixed; inset:0; z-index:9000; display:none; flex-direction:column; padding:40px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="color:#fff;">Bild auswählen</h2>
            <button onclick="closeLibrary()" style="background:none; border:none; color:#aaa; cursor:pointer;">Schließen</button>
        </div>
        <div id="media-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:15px; overflow:auto;"></div>
    </div>

    <div id="app" class="hidden" style="width:100%;">
        <aside>
            <div class="sidebar-header">
                <img src="https://cdn.prod.website-files.com/67f11742c5f3bcc352d799cc/67f14fa65b0383b0565fd742_emre%20details%20blue%20transparent%20bg.png" 
                     style="max-height:40px; width:auto; margin-right:15px;">
                <span style="color:#fff; font-weight:600;">Admin</span>
            </div>
            
            <div class="nav-category">Global</div>
            <div class="nav-item" onclick="openPage('globals')" id="nav-globals">
                <span><i class="fa-solid fa-globe" style="width:20px;"></i> Social & Logo</span>
            </div>

            <div class="nav-category">Seiten</div>
            <div id="page-nav"></div>

            <div style="margin-top:auto; padding:20px;">
                <button onclick="logout()" class="pill pill--ghost pill--full" style="color:#666;">
                    <i class="fa-solid fa-sign-out-alt"></i> Abmelden
                </button>
            </div>
        </aside>

        <main>
            <header>
                <h1 id="page-title" style="color:#fff; font-size:18px;">Lade...</h1>
                <div style="display:flex; gap:10px;">
                    <a href="/" target="_blank" class="pill pill--ghost" style="height: 38px;">
                        <i class="fa-solid fa-external-link-alt"></i> &nbsp; Website
                    </a>
                    <button onclick="saveAll()" id="save-btn" class="pill pill--primary" style="height: 38px;">
                        <i class="fa-solid fa-save"></i> &nbsp; Speichern
                    </button>
                </div>
            </header>
            <div class="editor-scroll">
                <div id="editor-container" class="editor-container"></div>
            </div>
        </main>
    </div>

    <script>
        // === CONFIG ===
        const pagesToScan = [
            { file: '/index.html', name: 'Startseite' },
            { file: '/leistungen.html', name: 'Leistungen' },
            { file: '/kontakt.html', name: 'Kontakt' },
            // Impressum/AGB/Datenschutz optional, da meist statisch
        ];
        
        const API = '/api/admin';
        let contentData = {};
        let scannedFields = {}; 
        let globalFields = []; 
        let currentImageKey = null;

        // === AUTH ===
        function checkAuth() {
            if(localStorage.getItem('token')) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('app').style.display = 'flex'; 
                initDashboard();
            }
        }
        async function requestLogin() {
            const email = document.getElementById('email-input').value;
            const res = await fetch(`${API}?action=login`, { method:'POST', body: JSON.stringify({email})});
            if(res.ok) { document.getElementById('login-step-1').classList.add('hidden'); document.getElementById('login-step-2').classList.remove('hidden'); }
            else document.getElementById('login-error').innerText = "Zugriff verweigert.";
        }
        async function verifyLogin() {
            const email = document.getElementById('email-input').value;
            const code = document.getElementById('code-input').value;
            const res = await fetch(`${API}?action=verify`, { method:'POST', body: JSON.stringify({email, code})});
            const data = await res.json();
            if(data.success) { localStorage.setItem('token', data.token); checkAuth(); }
            else document.getElementById('login-error').innerText = "Code ungültig.";
        }
        function logout() { localStorage.removeItem('token'); location.reload(); }

        // === CORE ===
        async function initDashboard() {
            try {
                const res = await fetch(API);
                contentData = await res.json();
            } catch(e) { contentData = {}; }
            await scanPages();
            openPage('globals'); 
        }

        async function scanPages() {
            const nav = document.getElementById('page-nav');
            nav.innerHTML = '';
            scannedFields = {};
            globalFields = [];
            const seenGlobals = new Set();

            for (let i = 0; i < pagesToScan.length; i++) {
                const page = pagesToScan[i];
                try {
                    const res = await fetch(page.file);
                    const text = await res.text();
                    const doc = new DOMParser().parseFromString(text, 'text/html');
                    
                    const pageFields = [];

                    doc.querySelectorAll('[data-edit]').forEach(el => {
                        const key = el.getAttribute('data-edit');
                        let type = 'text';
                        let defaultVal = el.innerHTML.trim();

                        if(el.tagName === 'IMG') {
                            type = 'image'; defaultVal = el.getAttribute('src');
                        } else if(el.getAttribute('data-type') === 'bg') {
                            type = 'image';
                            const match = (el.getAttribute('style')||'').match(/url\(['"]?(.*?)['"]?\)/);
                            if(match) defaultVal = match[1];
                        } else if(el.tagName === 'A') {
                            type = 'text'; defaultVal = el.getAttribute('href'); // Link
                        } else if(el.tagName === 'TEXTAREA' || el.innerText.length > 50) {
                            type = 'textarea';
                        }

                        const fieldObj = { key, type, defaultVal };

                        // Globals filtern: Nur Socials & Logo
                        if(key.includes('global_')) {
                            if(!seenGlobals.has(key)) {
                                seenGlobals.add(key);
                                globalFields.push(fieldObj);
                            }
                        } else {
                            pageFields.push(fieldObj);
                        }
                    });

                    scannedFields[i] = pageFields;
                    
                    const div = document.createElement('div');
                    div.className = 'nav-item';
                    div.id = `nav-p-${i}`;
                    div.onclick = () => openPage(i);
                    div.innerHTML = `<span><i class="fa-regular fa-file-lines" style="margin-right:10px;"></i> ${page.name}</span> <span class="badge-count">${pageFields.length}</span>`;
                    nav.appendChild(div);

                } catch(e) {}
            }
        }

        function openPage(id) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const container = document.getElementById('editor-container');
            container.innerHTML = '';

            let fieldsToShow = [];
            if(id === 'globals') {
                document.getElementById('nav-globals').classList.add('active');
                document.getElementById('page-title').innerText = "Globale Einstellungen";
                fieldsToShow = globalFields;
            } else {
                document.getElementById(`nav-p-${id}`).classList.add('active');
                document.getElementById('page-title').innerText = pagesToScan[id].name;
                fieldsToShow = scannedFields[id];
            }
            renderGroups(fieldsToShow, container);
        }

        // === RENDERER & GROUPING ===
        function renderGroups(fields, container) {
            if(!fields || fields.length === 0) {
                container.innerHTML = '<div style="color:#444; text-align:center; padding-top:40px;">Nichts zu bearbeiten.</div>';
                return;
            }

            const groups = {};
            const misc = [];

            fields.forEach(f => {
                const parts = f.key.split('_');
                // Verbesserte Gruppierung: z.B. "paket_1_titel" -> Gruppe "paket_1"
                if(parts.length >= 2) {
                    let groupKey = parts[0]; 
                    if(!isNaN(parts[1])) groupKey += `_${parts[1]}`;
                    
                    // Für Service Liste (svc_1_name)
                    if(parts[0] === 'svc' && !isNaN(parts[1])) groupKey = `service_${parts[1]}`;

                    if(!groups[groupKey]) groups[groupKey] = [];
                    groups[groupKey].push(f);
                } else {
                    misc.push(f);
                }
            });

            for (const [gKey, gFields] of Object.entries(groups)) {
                if(gFields.length === 1 && !gKey.includes('paket')) {
                    renderField(gFields[0], container);
                } else {
                    const card = document.createElement('div');
                    card.className = 'cms-card';
                    card.innerHTML = `<div class="cms-card-header"><span>${gKey.replace(/_/g, ' ')}</span></div>`;
                    const body = document.createElement('div');
                    body.className = 'cms-card-body';
                    gFields.forEach(f => renderField(f, body));
                    card.appendChild(body);
                    container.appendChild(card);
                }
            }

            if(misc.length > 0) {
                const card = document.createElement('div');
                card.className = 'cms-card';
                card.innerHTML = `<div class="cms-card-header"><span>Allgemein</span></div>`;
                const body = document.createElement('div');
                body.className = 'cms-card-body';
                misc.forEach(f => renderField(f, body));
                card.appendChild(body);
                container.appendChild(card);
            }
        }

        function renderField(field, parent) {
            let val = contentData[field.key];
            if(val === undefined || val === null) val = field.defaultVal || '';

            // Clean Labels
            let labelText = field.key.toUpperCase().replace(/_/g, ' ');
            const parts = field.key.split('_');
            if(parts.length > 2) labelText = parts.slice(2).join(' ').toUpperCase();
            if(labelText === 'LINK') labelText = 'ZIEL URL';

            const wrap = document.createElement('div');
            wrap.className = 'cms-field-wrap';
            
            let html = `<label class="cms-label-small">${labelText}</label>`;

            if(field.type === 'textarea') {
                // TOOLBAR FÜR FORMATTIERUNG
                html += `
                    <div class="format-toolbar">
                        <button class="format-btn" onclick="wrapTags('strong', '${field.key}')" title="Fett"><b>B</b></button>
                        <button class="format-btn" onclick="wrapTags('em', '${field.key}')" title="Kursiv"><i>I</i></button>
                        <button class="format-btn" onclick="wrapTags('u', '${field.key}')" title="Unterstrichen"><u>U</u></button>
                    </div>
                    <textarea id="input-${field.key}" oninput="updateVal('${field.key}', this.value)" class="cms-textarea">${val}</textarea>
                `;
            } else if(field.type === 'image') {
                let prevSrc = val;
                if(val && !val.startsWith('http') && !val.startsWith('data:') && !val.startsWith('../') && !val.startsWith('/')) {
                     prevSrc = '../' + val.replace(/^\.\//, '');
                }
                html += `
                    <div style="display:flex; gap:15px; align-items:center;">
                        <img src="${prevSrc}" id="preview-${field.key}" style="width:60px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #333; background:#000;">
                        <div style="flex:1; display:flex; gap:10px;">
                            <label class="pill pill--ghost" style="font-size:12px; padding:0 12px; height:36px; cursor:pointer;">
                                Upload
                                <input type="file" onchange="handleImage('${field.key}', this)" style="display:none;">
                            </label>
                            <button onclick="openLibrary('${field.key}')" class="pill pill--ghost" style="font-size:12px; padding:0 12px; height:36px;">Bibliothek</button>
                        </div>
                    </div>
                    <div style="font-size:11px; color:#444; margin-top:6px;">Quelle: ${val.substring(0,30)}...</div>
                `;
            } else {
                html += `<input type="text" value="${val.replace(/"/g, '&quot;')}" oninput="updateVal('${field.key}', this.value)" class="cms-input">`;
            }
            
            wrap.innerHTML = html;
            parent.appendChild(wrap);
        }

        function updateVal(k, v) { contentData[k] = v; }
        
        // --- TEXT FORMATTING ---
        function wrapTags(tag, key) {
            const el = document.getElementById(`input-${key}`);
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const text = el.value;
            if(start === end) return; // Nichts markiert

            const selected = text.substring(start, end);
            const before = text.substring(0, start);
            const after = text.substring(end);
            
            const newText = `${before}<${tag}>${selected}</${tag}>${after}`;
            el.value = newText;
            updateVal(key, newText);
        }

        // --- IMAGE LOGIC ---
        function handleImage(k, inp) {
            const f = inp.files[0];
            if(!f || f.size > 15*1024*1024) return alert('Max 15MB');
            const r = new FileReader();
            r.onload = e => applyImage(k, e.target.result);
            r.readAsDataURL(f);
        }
        function applyImage(k, src) {
            contentData[k] = src;
            let d = src;
            if(!src.startsWith('data:') && !src.startsWith('http') && !src.startsWith('/')) d = '../'+src.replace(/^\.\//,'');
            document.getElementById(`preview-${k}`).src = d;
        }
        function openLibrary(k) {
            currentImageKey = k;
            const grid = document.getElementById('media-grid');
            grid.innerHTML = '';
            const images = new Set();
            [globalFields, ...Object.values(scannedFields)].flat().forEach(f => { if(f.type === 'image' && f.defaultVal) images.add(f.defaultVal); });
            Object.values(contentData).forEach(v => { if(typeof v==='string' && v.startsWith('data:image')) images.add(v); });
            
            images.forEach(src => {
                let d = src;
                if(!src.startsWith('data:') && !src.startsWith('http')) {
                    if(!src.startsWith('../') && !src.startsWith('/')) d = '../' + src.replace(/^\.\//, '');
                }
                const div = document.createElement('img');
                div.src = d; div.className = 'media-item';
                div.style.width='100%'; div.style.aspectRatio='1'; div.style.objectFit='cover'; div.style.cursor='pointer';
                div.onclick = () => { applyImage(currentImageKey, src); document.getElementById('media-modal').style.display='none'; };
                grid.appendChild(div);
            });
            document.getElementById('media-modal').style.display='flex';
        }
        function closeLibrary() { document.getElementById('media-modal').style.display='none'; }

        async function saveAll() {
            const btn = document.getElementById('save-btn');
            const old = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner spin"></i> Speichern...';
            const res = await fetch(`${API}?action=save`, {
                method:'POST', headers:{'Authorization':localStorage.getItem('token')},
                body:JSON.stringify(contentData)
            });
            if(res.ok) { 
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Gespeichert'; 
                setTimeout(()=>btn.innerHTML=old, 1500); 
            } else { btn.innerText = 'Fehler'; }
        }

        checkAuth();
    </script>
</body>
</html>
